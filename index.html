<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Web3 Wallet Access</title>
  <style>
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #0f111a;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      color: #e0e0e0;
      padding: 20px;
      box-sizing: border-box;
    }
    .card {
      background: #161a24;
      padding: 32px;
      border-radius: 16px;
      width: 100%;
      max-width: 420px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      text-align: center;
    }
    h1 {
      font-size: 26px;
      margin: 0 0 16px;
      color: #fff;
    }
    .description {
      font-size: 15px;
      line-height: 1.5;
      color: #aaa;
      margin-bottom: 28px;
    }
    .connect-btn {
      display: block;
      width: 100%;
      padding: 14px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 17px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    .connect-btn:hover {
      background: #2563eb;
    }

    /* Connected view */
    .connected-view {
      display: none;
    }
    .address {
      font-family: monospace;
      background: #0f131b;
      padding: 12px;
      border-radius: 8px;
      margin: 16px 0;
      font-size: 14px;
      word-break: break-all;
      color: #fff;
    }
    .balance {
      margin: 8px 0;
      font-size: 16px;
    }
    .network {
      display: inline-block;
      background: #22c55e;
      color: #000;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      margin: 8px 0;
    }
    .switch-buttons {
      margin: 16px 0;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
    }
    .switch-btn {
      padding: 6px 12px;
      background: #2a2f3a;
      color: #aaa;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
    }
    .switch-btn.active {
      background: #3b82f6;
      color: white;
    }
    .disconnect-btn {
      margin-top: 20px;
      padding: 10px 16px;
      background: #222;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      cursor: pointer;
    }
    .loading {
      color: #555;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="card">
    <!-- Initial Screen -->
    <div id="initScreen">
      <h1>Access Your Account</h1>
      <p class="description">
        Connect your crypto wallet to trade, swap, and manage digital assets securely.
        Supported on Ethereum, Polygon, BSC, Arbitrum, Base, and more.
      </p>
      <button id="connectBtn" class="connect-btn">Connect Your Wallet</button>
    </div>

    <!-- Connected Screen -->
    <div id="connectedScreen" class="connected-view">
      <h1>Wallet Connected</h1>
      <div class="address" id="userAddress">0x...</div>
      <div class="network" id="networkName">—</div>

      <div class="balance" id="ethBalance">ETH: <span class="loading">loading...</span></div>
      <div class="balance" id="usdcBalance">USDC: <span class="loading">loading...</span></div>

      <div class="switch-buttons" id="switchButtons"></div>

      <button class="disconnect-btn" onclick="handleDisconnect()">Disconnect</button>
    </div>
  </div>

  <!-- Ethers.js -->
  <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
  <script>
    // Chain config (name, id, USDC contract if exists)
    const chains = [
      { id: 1, name: 'Ethereum', usdc: '0xA0b86a33E6441E8C1a2d9F0a9B9a9a9a9a9a9a9a9'.toLowerCase() }, // Mainnet USDC (use real if needed)
      { id: 137, name: 'Polygon', usdc: '0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174'.toLowerCase() },
      { id: 8453, name: 'Base', usdc: '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913'.toLowerCase() },
      { id: 42161, name: 'Arbitrum', usdc: '0xaf88d065e77c8cC2239327C5EDb3A432268e5831'.toLowerCase() },
      { id: 10, name: 'Optimism', usdc: '0x0b2C639c533813f4Aa9D7837CAf62653d097Ff85'.toLowerCase() },
      { id: 56, name: 'BSC', usdc: null }, // BSC uses BUSD mostly; skip USDC
    ];

    const chainMap = {};
    chains.forEach(c => chainMap[c.id] = c);

    let provider;
    let signer;
    let currentChainId;
    let userAddress;

    const initScreen = document.getElementById('initScreen');
    const connectedScreen = document.getElementById('connectedScreen');
    const connectBtn = document.getElementById('connectBtn');
    const userAddressEl = document.getElementById('userAddress');
    const networkNameEl = document.getElementById('networkName');
    const ethBalanceEl = document.getElementById('ethBalance');
    const usdcBalanceEl = document.getElementById('usdcBalance');
    const switchButtonsEl = document.getElementById('switchButtons');

    // ERC-20 ABI (minimal)
    const erc20Abi = [
      "function balanceOf(address owner) view returns (uint256)",
      "function decimals() view returns (uint8)"
    ];

    connectBtn.addEventListener('click', connectWallet);

    async function connectWallet() {
      if (!window.ethereum) {
        alert('Please install MetaMask or a compatible wallet.');
        return;
      }

      try {
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        userAddress = ethers.utils.getAddress(accounts[0]);
        userAddressEl.textContent = userAddress;

        await setupProvider();
        renderSwitchButtons();

        initScreen.style.display = 'none';
        connectedScreen.style.display = 'block';

        // Listen for changes
        window.ethereum.on('accountsChanged', () => location.reload());
        window.ethereum.on('chainChanged', () => location.reload());
      } catch (err) {
        console.error(err);
        alert('Connection failed.');
      }
    }

    async function setupProvider() {
      provider = new ethers.providers.Web3Provider(window.ethereum);
      signer = provider.getSigner();
      const network = await provider.getNetwork();
      currentChainId = network.chainId;

      const chain = chainMap[currentChainId] || { name: `Chain ${currentChainId}`, usdc: null };
      networkNameEl.textContent = chain.name;

      await updateBalances(chain);
    }

    async function updateBalances(chain) {
      // ETH/native balance
      const ethBalance = await provider.getBalance(userAddress);
      const ethFormatted = ethers.utils.formatEther(ethBalance);
      ethBalanceEl.innerHTML = `ETH: ${parseFloat(ethFormatted).toFixed(4)}`;

      // USDC balance
      if (chain.usdc) {
        try {
          const usdcContract = new ethers.Contract(chain.usdc, erc20Abi, provider);
          const decimals = await usdcContract.decimals();
          const balance = await usdcContract.balanceOf(userAddress);
          const usdcFormatted = parseFloat(ethers.utils.formatUnits(balance, decimals)).toFixed(2);
          usdcBalanceEl.innerHTML = `USDC: ${usdcFormatted}`;
        } catch (e) {
          usdcBalanceEl.innerHTML = `USDC: —`;
        }
      } else {
        usdcBalanceEl.innerHTML = `USDC: —`;
      }
    }

    function renderSwitchButtons() {
      switchButtonsEl.innerHTML = '';
      chains.forEach(chain => {
        const btn = document.createElement('button');
        btn.className = 'switch-btn';
        if (chain.id === currentChainId) {
          btn.classList.add('active');
        }
        btn.textContent = `Switch to ${chain.name}`;
        btn.onclick = () => switchNetwork(chain.id);
        switchButtonsEl.appendChild(btn);
      });
    }

    async function switchNetwork(chainId) {
      if (currentChainId === chainId) return;

      try {
        await window.ethereum.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: '0x' + chainId.toString(16) }]
        });
        // Page will reload due to chainChanged listener
      } catch (switchError) {
        if (switchError.code === 4902) {
          // Chain not added — prompt to add
          const chain = chains.find(c => c.id === chainId);
          if (!chain) return;

          const chainInfo = {
            chainId: '0x' + chainId.toString(16),
            chainName: chain.name,
            nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
            rpcUrls: ['https://rpc.ankr.com/eth'], // fallback; better to use chain-specific RPC
            blockExplorerUrls: ['https://etherscan.io']
          };

          // Use chain-specific RPCs if needed (simplified here)
          if (chainId === 137) {
            chainInfo.rpcUrls = ['https://polygon-rpc.com'];
            chainInfo.nativeCurrency = { name: 'MATIC', symbol: 'MATIC', decimals: 18 };
            chainInfo.blockExplorerUrls = ['https://polygonscan.com'];
          } else if (chainId === 8453) {
            chainInfo.rpcUrls = ['https://mainnet.base.org'];
            chainInfo.blockExplorerUrls = ['https://basescan.org'];
          }

          try {
            await window.ethereum.request({
              method: 'wallet_addEthereumChain',
              params: [chainInfo]
            });
          } catch (addError) {
            alert('Failed to add network: ' + addError.message);
          }
        } else {
          alert('Network switch failed: ' + switchError.message);
        }
      }
    }

    function handleDisconnect() {
      provider = null;
      signer = null;
      connectedScreen.style.display = 'none';
      initScreen.style.display = 'block';
    }
  </script>
</body>
</html>
